# 0909\_「OAuth 徹底入門 セキュアな認可システムを適用するための原則と実践」 読書 継続 260 日

「OAuth 徹底入門 セキュアな認可システムを適用するための原則と実践」 を読んでいます。

脆弱性の章を読んでいます。

## よく狙われる保護対象リソースの脆弱性

### 保護対象リソースの脆弱性

アクセス・トークンが漏洩した場合、攻撃者は保護対象リソースのデータにアクセスできるようになってしまう。  
他には、XSS 攻撃にさらされる可能性がある。  
XSS 攻撃 とは、本来は無害で信頼できる Web サイトに対して悪意のあるスクリプトを注入し、同一生成元ポリシー（Same-Origin Plicy）などによるアクセス制限を回避しようとするもの。

### 保護対象リソースのエンドポイントの設計

#### リソースのエンドポイントをどのように守るのか

受け取ったデータをサニタイズする。

保護対象リソースのエンドポイントから正しい Content-Type を返すことが、最も重要な XSS 攻撃を回避する方法の一つ。

application/json を指定することで、文字列をサニタイズしなくても、ブラウザ上の攻撃が行われない。  
application/json である場合、"契約（Contanct）"をブラウザが尊重しており、Content-Type がこの値になっている場合、返されたリソースに対して JavaScript の実行を拒否する。  
ただ文字列をサニタイズをすることも組み合わせると良い。

「X-Content-Type-Options: nosniff」を使う　　
MIME スニッフィング（Content-Type とは異なるレスポンスの MIME を自動的に判別すること）を防ぐ

X-XSS-Protection 使う  
自動的に XSS 攻撃を除外する。

CSP を適用する。
「動的なリソースが何を読み込めるのかを HTTP ヘッダーを介して宣言することで、モダンなブラウザで XSS 攻撃のリスクを減らすのに役立つ」。

リソースサーバーに、リクエスト・パラメータを介して access_token を受け取ることをそもそもサポートしない。  
対象のエンドポイントへの XSS 攻撃が可能であったとしても、実際はできなくなる。

#### インプリシット付与方式へのサポートの追加

同一生成元ポリシー（Same-Origin Policy）  
「プロトコル://ドメイン:ポート」の形式が同じベース URL から提供されたコンテキストの場合のみお互いのコンテキストを使用できる。

オリジン間リソース共有（Cross-Origin Resource Sharing: CORS）  
Same-Origin Policy を解決することができる  
保護対象リソースに対しては、CORS を適用することは意味があるが、ユーザーとやりとりを行うページや入力フォームでは CORS を無効にしておくこと。

過去に JSON with Padding(JSONP)が好まれて使われていた。  
現在では、脆弱性（Rosetta Flash など）が見つかったためつかわれない

### トークンのリプレイ攻撃

OAuth2.0 とその前の OAuth1.0 の大きな違いのひとつは核となるフレームワークで暗号学的処理が必須ではなくなった点である。  
代わりに、OAuth2.0 はさまざまな接続に TLS が使われることを前提としている。  
HSTS という新たな標準がうまれ、RFC6797 で定義されている。  
HSTS はブラウザが安全な HTTP 接続をつかっている場合のみ Web サーバーとやりとりを行うべきで、安全ではない HTTP プロトコルでのやりとりの場合決しておこなうべきではないと宣言できるようにするもの。

ブラウザから HTTP を使ってエンドポイントにアクセスすると、そのたびに、ブラウザの内部で 307 リダイレクトがおこなわれる。  
これは想定外の暗号化されていない通信（プロトコル・ダウングレード攻撃など）を避けるためのものである。

### まとめ

- 保護対象リソースのレスポンスの信頼できないデータ全てに対してサニタイズを行う
- 対象のエンドポイントには適切な Content-Type を選択する
- できるだけブラウザが提供する保護の仕組みとセキュリティに関するヘッダーを活用する
- もし、保護対象リソースのエンドポイントがインプリシット付与方式（Implicit Grant Type）のフローをサポートしなければならない場合は CORS（Cross-OriginResource Sharing）を使う
- （可能なら）保護対象リソースに対して JSONP をサポートしない
- いつも TLS を使うようにし、その際は HSTS と組み合わせる
