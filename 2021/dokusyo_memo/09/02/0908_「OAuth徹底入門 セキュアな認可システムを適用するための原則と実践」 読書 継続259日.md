# 0908\_「OAuth 徹底入門 セキュアな認可システムを適用するための原則と実践」 読書 継続 259 日

「OAuth 徹底入門 セキュアな認可システムを適用するための原則と実践」 を読んでいます。

脆弱性の章を読み始めました。

## よく狙われるクライアントの脆弱性

### 一般的なクライアントのセキュリティ

クライアントがシークレットを持つ場合に確実にしなければならないことは、そのクライアント・シークレットを外部のパーティーから簡単にアクセスできないところに格納すること。  
アクセス・トークンとリフレッシュ・トークンを保持する場合も同様

他の OuAuth の脆弱性は、OAuth を認証プロトコルとして特に注意を払うことなく使ってしまうこと・  
「Confused Deputy Problem」やほかの認証に関するセキュリティの問題などにでくわす。

### クライアントに対する CSRF 攻撃

CSRF 攻撃を回避するために、認可コードによる付与方式とインプリット付与方式には state パラメータの利用が推奨されている。

state パラメータをクライアントに持たせることで、認可サーバーを呼び出す際に、そのままパラメータを渡すようにする。一致しないときに、やりとりを終わらせる。

### クライアント・クレデンシャルの不当な取得

ネイティブ・アプリケーションでは、インプリシット付与方式のフローを使うことは推奨されていない。  
client_secret を安全に格納することができないため。

### リダイレクト URI の登録

リダイレクト URI は、完全な URI を登録して完全一致の条件で要求しなければならない。  
そうでなければ、トークンの乗っ取り（Token Hijacking）が簡単に行えるようになるため。

#### HTTTP リファラーを利用した認可コードの不正な取得

HTTP リファラーとは、あるページから別のページに遷移する際にブラウザ（および、一般的には HTTP クライアント）によって設定されるもの。そこからリクエストがきたのか参照できるようになる。

攻撃者は redirect_uri を指定することで、認可コードを獲得する。

以下のような問題点が発生する

- OAuth は一度だけ認可するので、それ以降、認可コードをもつユーザーを信頼してしまう
- 多くの人は、フィッシングに対して危機感を持たずにアクセスしてしまう

#### オープン・リダイレクトによるトークンの不正な取得

インプリシット付与方式を用いて、今の攻撃の流れで別の攻撃が行われることもある。

（オープン・リダイレクトとは）アプリケーションがパラメータを受け取り、その受け取ったパラメータの値を検証することなくユーザーをリダイレクトしてしまうこと。この脆弱性はフィッシング攻撃に使われ、ユーザーに気づかれることなく悪意あるサイトにアクセスさせてしまう。

### 認可コードの不正な取得

認可コードをのっとっても、**まだ個人情報を盗み出せない**。アクセス・トークンを取得しなければ、盗み出すことはできない。  
認可コードをアクセス・トークンと交換するためには、client_secret は必要であるので、厳重に保護されないといけない。

### トークンの不正な取得

RFC7650 では、Bearer トークンを渡すための方法が２つ定義されている。  
うちひとつは、URI のクエリー・パラメータを使うことで、クライアントはアクセス・トークンを URI にある access_token のクエリー・パラメータに設定して送る・この方法は以下の問題点がある。

- URI に含まれているアクセス・トークンが access.log に書き出されてしまう
- オンラインの掲示板などにコピペして、アクセス・トークンが漏洩してしまう
- Referer ヘッダーには URL 全体が含まれるようになっているため、そこに含まれているアクセス・トークンが漏洩してしまう

### ネイティブ・アプリケーションでのベスト・プラクティス

「OAUuth 2.0 for Native Apps」では以下のように推奨している・

- リダイレクト URI に自作の URL スキームを使う場合、そのスキームには世界で一意となる名前を選択し、対象のアプリケーションのみが利用するスキームであることが明確に分かるものにする。この方法を実装する一つに、DNS 表記を逆にしたものを使う方法がある。
- 認可コード横取り攻撃に関連するリスクのいくつかを回避するためには、PKCE を使うことは良い考えである

### まとめ

- 仕様で提案されているように state パラメータを使うようにする
- 付与方式（Grant Type）について理解し、対象のアプリケーションで使うべき正しい付与（のフロー）を選択するようにする
- ネイティブ・アプリケーションではインプリシット付与方式（Implicit Grant Type）フローを使うべきではない。そのフローはブラウザ内のクライアントで使われることを意図されているからである。
- ネイティブ・アプリケーションのクライアントで client_secret を保護することは動的クライアント登録のように実行時に構成情報を設定できないかぎり不可能である
- 登録された redirect_uri はできるだけ完全一致するようにすべきである
- access_token を URI パラメータとして渡さないで済むのなら、決して渡してはいけない
