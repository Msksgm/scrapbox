# 0910\_「OAuth 徹底入門 セキュアな認可システムを適用するための原則と実践」 読書 継続 261 日

「OAuth 徹底入門 セキュアな認可システムを適用するための原則と実践」 を読んでいます。

脆弱性の章を読んでいます。

## よく狙われる認可サーバーの脆弱性

### 一般的なセキュリティ

たくさんある、以下は一例

- サーバーログを安全にすること
- TLS（Transport Layer Security）を有効な証明書とともに使うこと
- 適切なアカウントのアクセス制御をしつつ、OS のホスト環境を安全に運用すること

「Web は危険な場所です。このアドバイスをきちんと覚えておいて、注意を払って行動しましょう」

### セッションの乗っ取り

認可コードによる付与方式では、リダイレクトを使ってクライアントに認可コードを渡す。  
認可コードがサーバーから離れ、ユーザー・エージェントを動かして機密クライアント（Confidential Client）に渡されるため、認可コードはブラウザ履歴に残ってしまう。  
攻撃者は履歴にのこっった認可コードを使って、被害者の保護対象リソースにアクセスすることができてしまう。

そのため、
**クライアントは認可コードを２回以上使ってはいけない（MUST NOT）。もし、ある認可コードが複数回使われようとする場合、認可サーバーはそのリクエストを拒否しなくてはならず（MUST）、そして、この日課コードをもとに発行されたすべてのトークンを（可能な場合）取り消すべきである。**

また、認可コードによる付与方式で行っているもうひとつの保護は認可コードと client_id を紐づけることである。  
これは RFC6749 のセクション 4.1.3 にあげてある次の条件を満たす。  
**その認可コードが認証された機密クライアント（Confidential Client）に発行されたものであることを確認するか、もしくは、クライアントがパブリック・クライアント（Public Client）である場合、この認可コードはリクエストに含まれている「client_id」が表すクライアントに発行されたものであることを確認してください。**

これらのチェックがないと、どのクライアントでも別のクライアントに発行された認可コードを使ってアクセス・トークンを取得できるようになってしまう。

### リダイレクト URI の不正操作

OAuth に使われる redirect_uri は厳重に扱うべきである。  
その検証方法に関しては完全に認可サーバーに任せている。  
一般的に３つの検証アルゴリズム（完全一致、サブディレクトリの許可、サブドメインの許可）のどれかを使って登録された redirect_uri を検証する。

#### 完全一致

受け取った redirect_uri のパラメータを取り出し、その redirect_uri の値と記録されたクライアントの redirect_uri の値と単純に文字列比較をする。

#### サブディレクトリの許可

受け取った redirect_uri にいろいろと付け足されたものであるのなら、有効とする

#### サブドメインの許可

リクエストされた redirect_uri が登録された redirect_uri のサブドメインであるのなら、その redirect_uri は有効であるとみなす。

サブディレクトリの許可とサブドメインの許可を組み合わせることで、柔軟性を持った許可をおこなうことができる

### クライアントのなりすまし

OAuth2.0 認可フレームに関する使用のセクション 4.1.3 より  
**（認可サーバーは）redirect_uri のパラメータがセクション 4.1.1 での説明のように最初の認可リクエストに含まれているばあい、（あとのリクエストでも）redirect_uri のパラメータが存在することを確認してください。そして、そのパラメータが含まれているのなる、それらの値が一致することを確認してください**

攻撃者が認可コードを取得しても、client_secret が何なのか知らないのいので、保護対象リソースにアクセスすることができない。  
認可コードを取得するさいに、redirect_uri に対してなんらかの改竄をおこなっている。これは、認可サーバーのずさんな redirect_uri の検証アルゴリズムによって引き起こされる。  
ここで、攻撃者は、この奪い取った認可コードを被害者の OAuth クライアントのコールバック・えんどぽいんとに提示する。そうすることで、クライアントは処理を進めていき、有効なクライアントのクレデンシャルを認可サーバーに提示することで、認可コードとアクセストークンを交換する。  
こうすることで、攻撃者は、保護対象リソースを盗むことができるようになる。

認可サーバーのトークン・エンドポイントを確認している箇所で、認可リクエストの最初に提示された redirect_uri とトークンのリクエストに提示されたものが一致するかを確認する。一致しない場合、攻撃は失敗に終わる。

### オープン・リダイレクトによる脆弱性

OAuth2.0 認可フレームワークの使用に関するセクション 4.1.2.1

> もし、リクエストのリダイレクト URI が含まれていなかったり、不正だったり、一致しなかったりしたため失敗に終わる場合、もしくは、クライアント識別子が抜けている場合や不正である場合、認可サーバーはそのエラーが起こったことをリソース所有者に伝えるべきであり（SHOULD)、ユーザー・エージェントに自動で不正なリダイレクト URI へのリダイレクトをさせてはいけません（MUST NOT）
> もし、リソース所有者がアクセスに関するリクエストを拒否した場合、もしくは、リダイクト URI の欠如や不正以外の理由でリクエストが失敗する場合、認可サーバーは次のパラメータをリダイレクト URI のクエリーに加えることでクライアントに伝えるようにします・・・・

redirect_uri にリダイレクトするのをやめる。代わりに`HTTP 400 Bad Request`をかえすようにする。

他には

- リダイレクト先を認可サーバーの制御下にある仲介役としてふるまう URI を設定し、そこで、セキュリティ・トークンの情報を含むであろうブラウザの Refere 情報をなくすようにする
- 「#」にエラーのリダイレクト URI を追加する（こうすることで、ブラウザが前の URI からのフラグメントを新しい場所を示す URI にサイド付け加えることを防ぐ）

がある

### まとめ

- 一度使われた認可コードは破棄するようにする
- 認可サーバーが採用すべき唯一の安全な redirect_uri の検証方法は完全一致
- OAuth2.0 認可フレームワークの仕様を記述どおりに実装してしまうと、オープン・リダイレクトの脆弱性を使った攻撃の対象に認可サーバーがなってしまう可能性が高くなる。もし、これが適切に監視されている環境下でリダイレクトを行っているのなら問題ないが、何も注意せずそのまま実装してしまうとなんらかの脅威がもたらされる危険性がある
- エラーを報告する際は、フラグメントや Referer ヘッダーを介して情報が漏洩する可能性があることに注意を払う
