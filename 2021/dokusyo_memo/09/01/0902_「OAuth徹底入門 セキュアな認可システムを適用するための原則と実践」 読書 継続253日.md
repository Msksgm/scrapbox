# 0902\_「OAuth 徹底入門 セキュアな認可システムを適用するための原則と実践」 読書 継続 253 日

「OAuth 徹底入門 セキュアな認可システムを適用するための原則と実践」 を読んでいます。

## 2 OAuth ダンス

### OAtuh2.0 プロトコルの概要〜トークンの取得と使用〜

OAuth のトランザクションは大きく分けて２つに分割できる。1.トークンの発行、2.トークンの使用。

トランザクションは次の流れで構成される

1. リソース所有者はクライアントにリソース所有者の代わりとしてふるまって欲しいことを指示する
2. クライアントは認可サーバー（Authorization Server）にリクエストをし、そこで、リソース所有者にクライアントを認可するかどうかの判断を行わせる
3. リソース所有者はクライアントを認可する
4. クライアントは認可サーバーからトークンを受け取る
5. クライアントは保護対象リソースにトークンを提示する

### OAuth2.0 における認可付与の詳細

#### 認可コードによる付与（Authorization Code Grant）

一時的なクレデンシャルである認可コードを使い、リソース所有者からクライアントへ委譲されたことを示す

手順

1. リソース所有者はクライアント・アプリケーションを呼び出し、このクライアントにリソース所有者の代わりとして保護対象リソースを使わせたいこととを伝える。
2. クライアントが新しい OAuth のアクセス・トークンを取得する必要があると認識した場合、クライアントはリソース所有者を認可サーバーに送り、そのリソース所有者によって必要な権限を委譲されるように認証サーバーにリクエストする
3. クライアントは認可サーバーに自身を識別させて、スコープなどの特定のアイテムをリクエストする。そのため、ユーザーを送る URL のクエリー・パラメータに必要な情報を含める。
4. 認可サーバーはユーザーに認証するように要求する。ユーザーの認証情報はユーザー（とそのユーザーがいるブラウザ）と認可サーバーのあいだで直接受け渡される。この情報はクライアントアプリケーションからは決してみられることはない
5. ユーザーはクライアント・アプリケーションを認可する。リソース所有者は自身の権限をどの程度クライアント・アプリケーションに委譲するのかを選択し、認可サーバーはこの委譲をうまく行わせるためにさまざまな方法を選択できるようになっている。
6. 認可サーバーはリダイレクトを使って、ユーザーをクライアント・アプリケーションに戻す。これはクライアントへの「redirect_uri」に HTTP リダイレクトをすることで行われる。
7. ブラウザは HTTP リクエストをクライアントに対して発行する。この HTTP リクエストはクライアントに対してのものであり、認可サーバーに対してのものではない。認可コードによる付与方式を使っているので、このリダイレクトには特別なクエリー・パラメータである、一度しか使えないクレデンシャルの認可コードと呼ばれるもの。
8. 認可サーバーはこのリクエストを受け取り、リクエストが有効ならばトークンを発行する。その際に、認可サーバーは多くの手順を踏んで、このリクエストが正当であることを確認する。
9. クライアントはトークンを取得すると、そのトークンを保護対象リソースに提示できるようになる。クライアントがアクセス・トークンを提示するためには、いくつかの方法があり、本書では Authorization ヘッダーを使ったトークンの提示をしている

### 2.3 クライアント、認可サーバー、リソース所有者、保護対象リソース

４つのアクターとなる構成要素

OAuth のクライアントはソフトウェアであり、リソース所有者の代わりとして保護対象リソースへのアクセスを試みるもの。OAuth はそこへのアクセス権を得るために使われる。

OAuth の保護対象リソースは HTTP サーバーから提供されており、そのリソースにアクセスするには OAuth のトークンが必要になる。保護対象リソースは提示されたトークンを検証して、リクエストに答えるのかどうか、そして、どのように応えるのかを決定する。トークンを信頼するかどうかの最終的な決定権を持つ存在になる。

リソース所有者はクライアントにアクセス権を委譲する権限を持つ存在。クライアント・アプリケーションを使っているユーザー。

認可サーバーは OAuth の仕組みの中心的な役割を担う HTTP サーバーのこと。認可サーバーはリソース所有者とクライアント所有者とクライアントの認証をおこない、リソース所有者にクライアントを認可するための仕組みを提供し、トークンをクライアントに発行する。

### トークン、スコープ、認可付与

#### アクセス・トークン

認可サーバーによってクライアントに発行され、クライアントに権限が委譲されたことを示すもの。  
OAuth トークンはクライアントにとっては無意味な文字列であり、これはクライアントはトークンの中身について知る必要がないということ。

#### スコープ

保護対象リソースの権限を表すもの。  
スコープは OAuth のプロトコルでは文字列によって表現され、複数のスコープを空白で区切ってひとつにまとめたフォーマットになっている。
