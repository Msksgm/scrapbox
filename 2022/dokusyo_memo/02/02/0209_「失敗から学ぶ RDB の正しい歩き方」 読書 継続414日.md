# 0209\_「失敗から学ぶ RDB の正しい歩き方」 読書 継続 414 日

## 第 5 章　フラグの闇

「とりあえず削除」フラグは以下の問題点をもつ

- クエリの複雑化
  - JOIN するたびに指定する必要がある
- UNIQUE 制約が使えない
  - 同じ名前が出てくるので UNIQUE 制約が使えない
- カーディナリティが低くなる

アンチパターンをうまないために

事実のみを保存する。削除済みテーブルに移行する
トリガーを使う
View を使う

状態をもつのを許容されるパターン

- 対象のテーブルが小さく、INDEX が不要
- そのテーブルが関連するテーブルの親になることがなく、データを取得する際に頻繁に JOIN の太陽になることがない
- UNIQUE 制約が不要

安易にテーブルに状態を持たせてはならない

## 第 6 章 ソートの依存

リレーショナルモデルとソートのしくみ

集合の性質

- 重複がない
- 実在する要素しかない（NULL がない）
- 要素に順序がない

ORDER BY のしくみ

クエリ受信、構文解析、書き換え、実行計画生成・最適化、実行、結果送信

WHERE 句ねらいの INDEX

ORDER BY 句狙いの INDEX

## 第 7 章 隠された依存

意味を含んだ ID
複数の目的に使われるテーブル

似たようなアンチパターン

EAV（エンティティ・アトリビュート・バリュー）
以下のような点がある

- その属性名に対する値があるのかないのか
- その属性名があるのかないのか
- 属性名と値の組み合わせは正しいのか
- 属性名の一覧

設計上の問題

- 必須属性が設定できない
- データ型が指定できない
- 正規化されていないため外部キー制約（参照整合性制約）が強制できない
- 属性名を補う必要がある

Polymorphic Associations（ポリモーフィック関連）

子テーブルが複数の親テーブルを持つような関係

隠された状態が生む問題

- コードやデータから見えない状態の辛さ
- 失われた制約
  - 無防備になるデータベース
  - ドキュメントがないのでコードから読み解く必要がある
  - 制約が守るもの

アンチパターンを生まないために

意味を含んだ ID のリファクタリング
ポリモーフィック関連のリファクタリング
複数の目的で使われるテーブルのリファクタリング

アンチパターンのポイント

- データに複数の意味を持たせない
- １つのデータの責務を小さくする
- 常に状態が見えるようにするために事実のみ保存する
