# 0210\_「失敗から学ぶ RDB の正しい歩き方」 読書 継続 415 日

## 第 8 章　 JSON の甘い罠

すべての値を JSON として保存したことによるアンチパターン。
スキーマレスで変化に柔軟な設計ができるが、検索複雑性が上がったり、更新のコストがあがったりする。

JOIN、JOIN をサポートする関数や演算子、LATERAL 句が必要になる

「なんでも JSON」の危険性

- ORM が使えない
- データの整合性が保てない
  - 必須属性の指定が難しい
  - データの中身を指定できない
  - 参照整合性制約を指定できない

JSON データ型のメリット

1. JSON そのものに対応している
2. スキーマレスに値を保存できる

JSON データ型を使うユースケース

- Web API の戻り値
  - 予告なく変更する API、戻り値が Error でも対応する
  - 必要なデータは正規化してその他が含まれる JSON は別テーブルに分けるとき
- OS 情報
  - レコード数がすくない（数千程度だった）
  - 一度保存したレコードに対して UPDATE することはほとんどない
  - 取り出すときは JSON をまるごと取得
- ユーザが任意で登録するプラグインの情報
  - プラグインで必要な設定値を保存するカラム
  - 「プラグインが依存するプラグイン」がある場合のプラグイン名とバージョンを記載するカラム

## 第 9 章 強すぎる制約

過剰の制約の利用によって柔軟性を失ったこと
早すぎる最適化は、仕様変更時に大きな壁になる

外部キー制約が生み出すデッドロック
DOMAIN に似た ENUM 型
状態を持つ CHECK 制約

アンチパターンを生まないためには

- 制約と規約
  - アプリケーション側に規約としてもたせる
- 制約は敵か味方か
  - データは「成長する生き物」
  - RDBMS の責務とアプリケーションの責務を正しくわける

制約の段階

段階,説明
制約なし,制約がない状態
弱い制約,NOT NULL 制約、UNIQUE 制約、外部キー制約など、データ構造を守るうえでの必要最低限の制約がかかった状態
強い制約,CHECK 制約や EXCLUDE 制約など、RDBMS の機能に依存するが適切につかうことでデータを的確に守ることができる
強い制約,制約の内容が、「システムの使用や」、「ビジネスルール」に基づいて記述される状態

アンチパターンのポイント
強すぎる制約は RDBMS 特有の問題であり、しかし安易に避けるとより悩ましい問題を生み出す

## 第 10 章 転んだ後のバックアップ

バックアップの方法を適切に覚えること

- 論理バックアップ
  - SQL や CSV として、DB そのものを再構成できるようにバックアップを取ること
- 物理バック
  - データベースの物理ファイルをまるごとバックアップする手法
- PITR（ポイントインタイムリカバリ）
  - 特定の日時にリストアできる手法のこと

バックアップの設計

- RPO：設計できるデータ
  - 「障害が発生したときに、いつの時点のデータを復旧するか」の指針
- RTO：復旧までにかかる時間
  - 「障害が発生してから目標の状態へ復旧するまでの時間」の指針
- RLO：復旧したいデータ
  - 「障害の発疹した場合に、実際にどこまで復旧させるか」の指針

バックアップ戦略

なぜバックアップが必要か

レプリケーションは以下のような場合防げない

- アプリケーションのバグによるデータ破壊からの復旧
- 不正なデータ投入からの復旧
- ヒューマンエラーからの復旧
- レプリケーション破壊といったシステム破壊からの復旧

バックアップの落とし穴

以下の場合バックアップの運用を見直す必要がある

- システムに関わるデータベースが増えた
- サーバを入れ替えた
- OS やミドルウェアのバージョンアップ
- バックアップから復旧したことが一度もない
- 更新情報を持ったログを削除していない

リストアできないバックアップ

- バックアップ・リストアの手順書がない
- 最初にシステム設計した人がすでにいない
- チームで定期的に訓練をしていない
- システムの面倒を見る作業が属人化している

アンチパターンを生まないためには

- バックアップが正しく行われていることを毎回確認し、失敗したときに必ず気を付けるようにする
- リストアを定期的に行う
- 手順書にまとめる。ベーシックな手順だけではなく、実際のユースケースに則したパターンをいくつか用意すると良い

バックアップとリストアの自動化

筆者のやり方

1. 本番から必要なデータをバックアップ
2. バックアップからステージングを生成
3. ステージングと本番の差分確認（本番用のシナリオテストを実行）
4. ステージングに不必要なデータを DROP したり変更したりする

チーム内でリストアする機会を定期的に作る

クラウドサービスの利便性

## 第 11 章 見られないエラーログ

エラーログをみること

エラーログを見ない人が多い理由

- エラーログに関する無知
- エラーログが見られない/見づらい

PostgreSQL のエラーログ

深刻度,使用方法,syslog,eventing
DEBUG1~DEBUG5,開発者が使用する連続的かつ詳細な情報を提供,DEBUG,INOFRMATION
INFO,ユーザによって暗黙的に要求された情報,INFO,INOFRMATION
NOTICE,ユーザーの補助になる情報,NOTICE,INFORMATION

アンチパターンを生まないために

- 運用ログ
  - いつ（タイムスタンプ）
  - だれが（ユーザ）
  - どこに（データベース）
- 監査ログ
  - そこから（クライアントの IP など）
  - 何をしたか（実行された SQL コマンド）
  - どうなったか（エラーコード、エラーメッセージ）

エラーログの監視

- 深刻度による場合分け

- 通知の仕組み
  - 重要な通知を知るべきすべての人にすばやく・正しく・もれなく通知できる
- 可視化のしくみ
  - ロギングするが通知しない情報については、Elasticsearch を使って可視化できるようにしている
