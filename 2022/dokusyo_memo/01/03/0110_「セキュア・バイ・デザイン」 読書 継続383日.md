# 0110\_「セキュア・バイ・デザイン」 読書 継続 383 日

## 第３章

## 3.2

本書で注目する DDD の要素

- エンティティ
- 値オブジェクト
- 集約

### 3.2.1 エンティティ

- 自分自身を特定できるようにする識別子をもっている
- エンティティの識別性はそのエンティティが存在している間はかわることがない
- エンティティは他のオブジェクト、例えば、他のエンティティや値オブジェクトをもつことができる
- エンティティは自身が所有するオブジェクトの操作を調整する責務を有する

DDD における識別性は多くの言語で意味する識別性もしくは同等性と同じではない

エンティティをモデリングするさいの注意点は以下のどちからを満たす属性および振る舞いを持たせる

- エンティティを定義するのに不可欠な
- エンティティを識別する手助けとなるような

エンティティは自身の振る舞いにのみ注意を払うの h であなくエンティティが保持する他のオブジェクトの振る舞いに関する調整も考慮しなければならない

### 3.2.2 値オブジェクト

- 自身と他のオブジェクトを比較する識別子を持たないが、値で比較する
- 不変である
- 完結した概念を形成しなくてはならない
- エンティティを参照できる
- 重要な制約が明確に定義されており、その制約を守らせるようになっている
- エンティティや他の値オブジェクトの属性として使われることがある
- 生存期間は短いことが多い

完結した概念（conceptual whole）とは、「値オブジェクトは何も欠けていない完結な値でなくてはならない」こと

### 3.2.3 集約（aggreagte）

集約とは

- モデルに含まれる様々な要素をまとめて概念的な境界を構築するのに使われる
- トランザクションの管理可能な境界を定めている

ルール

- 境界（boundary）とルート（root）がある
- ルートは１つしかない
- ルートは、グローバルな識別性をもち、境界内のオブジェクトへのすべてのアクセスを制御する
- ローカルのエンティティは、識別子は境界内で一意となるが、外部から参照されることはない
- ルートは値オブジェクトの参照を他のオブジェクトに渡せるようにすることができる
- 集約を構成するオブジェクト間の不変条件はトランザクションが行われるたびに、その中で常に維持されるようにする
- 不変条件が複数の集約に広がってしまうと、正しい状態が常に保たれていることを期待できなくなる。ただし、最終的に正しい状態が保たれるようにすることはできる
- 集約ないのオブジェクトは、他の集約への参照を保持できる

## 3.3 境界づけられたコンテキスト（bounded context）

境界づけられたコンテキスト

- ドメイン・モデルが適用される範囲を定義するもの
- セキュリティの観点でも重要

ユビキタス言語
In anywhere
ビジネスで使われる用語・振る舞い・概念を表現するために統一された言語ではない
意味的（semantic）において異なる

semantic boundary を超えるものは、セキュリティ的に気をつけなければいけない

## 3.4 異なるコンテキスト間でのやりとり

異なるコンテキスト間でのやりとりについてかんげたとき、境界はセキュリティにおいて重要な観点になる

DRY 原則は、意味的な重複を取り除くもの

Conway の法則とは「システムを設計する組織は、その構造をそっくりまねた構造の設計を生み出してしまう」

# 第４章 安全性を確立する実装テクニック

テクニック

- 不変性（immutability）
- 速やかな失敗（fail-fast）
- 妥当性確認（validation）

## 4.1 不変性

不変性の問題は以下の２つにわけられる

- データの完全性（integrity）
- データの可用性（availability）

本書では、多分（軽量）CQRS をエンティティ・スナップショットと呼んでいる

## 4.2 契約（contract）を使った速やかな失敗（fail-fast）

契約はメソッドが意図したように機能する為の事前条件と処理を終えたあとオブジェクトがどのように変わっているかの事後条件のこと

契約はメソッドに対する契約ではなく、クラスに対する契約であり、クラス全体の責務である

速やかな失敗（fail-fast）とは事前条件が満たされていなかったらすぐに作業を止める実装のこと

public メソッドは契約が必須、パッケージ public はケースバイケース、private は不要

DRY 原則に反しているときは、ドメイン・プリミティブ（domain primitive）を使うことを推奨する
