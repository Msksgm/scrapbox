# 0319\_「図解でなっとく！トラブル知らずのシステム設計　エラー制御・排他制御編」 読書 継続 458 日

## 第 6 話 私、エンハンスがんばります!

排他制御とは
「共有資源に対して複数トランザクションからの操作が見込まれる場合に、同時アクセスにより不整合が発生することを防ぐため、あるトランザクションから共有資源にアクセスしているときは、他トランザクションからはアクセスできないようにして、直列に処理されるようにする制御」のこと

問題
複数の同時アクセスで不整合が発生してしまう
対策
排他制御を実装する

楽観ロック

- ロックキー
  - バージョン比較、タイムスタンプ比較、全列データ比較
- 更新方法
  - SELECT FOR UPDATE で考慮漏れを減らす

データベースのロックメカニズムだけでは、排他制御として十分でない

業務トランザクションの範囲は画面構成によって異なる

UPDATE WHERE には 2 つの懸念がある

- 1 つめの懸念は、排他制御の判定が「遅い」判定となってしまうこと
- 2 つめの懸念点は、「UPDATE WHERE 方式」だと楽観ロックによるエラーが発生したことは、データ更新ができなかったという結果として把握される

## 第 7 話

クレーム処理をご一緒に

「楽観」とは「めったなことじゃ他者による更新は起きないだろう」という楽観的な全体のこと

他者による更新が頻繁にある場合、楽観ロックでは、業務終了時にならないと排他エラーだとわからない
「悲観ロック」を採用する

1. ロック対象を選択する
2. ロックを解除するときは、あらためて自身がロックしていることを確認する

悲観ロック

絶対に実施する

- 業務を開始するタイミングで、ロック状態をチェックする。他ユーザーがロックしている場合は排他エラーとして業務開始できないようにする
- 業務完了（更新処理実施）のタイミングで、ロック状態をチェックする。ロックされていない、もしくは他ユーザーがロックしている場合は排他エラーとして更新は行わない

業務トランザクションと DB トランザクションは異なる
基本的に業務トランザクションは楽観ロック、DB トランザクションは悲観ロック
業務トランザクションを悲観ロックにするときにはロックを解除するのが難しい
